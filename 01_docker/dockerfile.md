# Dockerfile

В этом руководстве мы посмотрим, как упаковать приложение [без зависимостей](assets/app.bin) в Docker-образ и запустить контейнер.

В большинстве случаев, приложение, не использующее внешних зависимостей (статически слинкованное), не требует контейнеризации, поскольку мы получаем исполняемый файл, который можно развернуть в целевой операционной системе.

Но самое важное - контейнеризация унифицирует процесс эксплуатации приложений на разных языках. Т.е. системным администраторам или другим сотрудникам, отвечающим за эксплуатацию приложений (в том числе развёртывание, мониторинг) будет удобнее, если все приложения будут поставляться в унифицированном формате вроде Docker образов. Именно поэтому мы рассматриваем упаковку приложений в образ.

`Dockerfile` - специальный текстовый файл, описывающий процесс создания образов (он должен находиться в том же каталоге, что и файл `app.bin`).

## Layered system

Почти каждая инструкция, которую мы будем рассматривать, создаёт в рамках образа определённый слой (layer):

```
+------------------------+
|        layer N         |
+------------------------+
|        layer N - 1     |
+------------------------+
|        ...             |
+------------------------+
|        layer 1         |
+------------------------+
```

Вы можете представлять каждый слой в виде снапшота (слепка) файловой системы. Эти уровни накладываются друг на друга (снизу вверх), формируя итоговое состояние файловой системы.

Это позволяет:
1. Переиспользовать слои между несколькими образами
1. Экономить время сборки (мы переделываем только необходимые слои и все вышестоящие)

Сами слои являются неизменяемыми.

Давайте попробуем посмотреть, как работа со слоями выглядит на практике.

## `FROM`

Инструкция `FROM` позволяет выбрать базовый образ, с которого мы хотим начать создание собственного.

Мы начнём с самого "нуля" и возьмём специальный образ [`scratch`](https://hub.docker.com/_/scratch) (он, кстати, не создаёт layer'a) - это "пустая" ФС, в которой нет никаких файлов.

```dockerfile
FROM scratch
```

Примечание*: вы можете использовать [любой образ](https://hub.docker.com) в качестве базового (пока мы умеем работать только с общедоступными с Docker Hub, но позже научимся и с другими).

## `COPY`

Инструкция `COPY` предоставляет вам возможность добавить из локальной файловой системы (с вашего компьютера) файлы и каталоги в образ.

Формат команды следующий: `COPY src dst`, где `src` - это исходный файл или каталог, а `dst` - это целевой файл или каталог.

```dockerfile
FROM scratch

COPY app.bin /
```

Примечание*: предварительно убедитесь, что у файла есть права на исполнение (`chmod +x app.bin`)

Обратите внимание: в качестве `src` мы написали имя файла, а в качестве `dst` - имя каталога (т.к. заканчивается на `/`). В итоге наш файл будет скопирован в каталог `/`.

Теперь можем попробовать собрать наш первый образ:

```shell script
docker build .
```

Лог:

```
Sending build context to Docker daemon  2.193MB
Step 1/3 : FROM scratch
 ---> 
Step 2/3 : COPY app.bin /
 ---> 66535cd5be8d
Step 3/3 : CMD /app.bin
 ---> Running in 1ed1c71ff674
Removing intermediate container 1ed1c71ff674
 ---> b2c25c8fe693
Successfully built b2c25c8fe693
```

Примечание: у вас "цифры" (на самом деле это первые символы хеша слоёв) могут отличаться.

Теперь если выполнить команду `docker image ls`, то мы увидим наш образ в списке:

```
REPOSITORY     TAG        IMAGE ID          CREATED             SIZE
<none>         <none>     b2c25c8fe693      About a minute ago  2.19MB
```

При попытке повторной сборки (`docker build .`) мы увидим, что ничего заново не соберётся, а Docker просто переиспользует полученные слои (`---> Using cache`):

```
Sending build context to Docker daemon  2.193MB
Step 1/3 : FROM scratch
 ---> 
Step 2/3 : COPY app.bin /
 ---> Using cache
 ---> 66535cd5be8d
Step 3/3 : CMD /app.bin
 ---> Using cache
 ---> b2c25c8fe693
Successfully built b2c25c8fe693
```

## Label

Как вы видели, не особо удобно распознавать образа по `id`:

```
REPOSITORY     TAG        IMAGE ID          CREATED             SIZE
<none>         <none>     b2c25c8fe693      About a minute ago  2.19MB
```

Поэтому давайте присвоим нашему образу тег:

```shell script
docker build -t ibdevapp .
```

Лог:
```
Sending build context to Docker daemon  2.193MB
Step 1/3 : FROM scratch
 ---> 
Step 2/3 : COPY app.bin /
 ---> Using cache
 ---> 66535cd5be8d
Step 3/3 : CMD /app.bin
 ---> Using cache
 ---> b2c25c8fe693
Successfully built b2c25c8fe693
Successfully tagged ibdevapp:latest
```

```
REPOSITORY     TAG        IMAGE ID          CREATED             SIZE
ibdevapp       latest     b2c25c8fe693      4 minutes ago       2.19MB
```

## `CMD`

Инструкция `CMD` используется для непосредственного указания исполняемого файла (который будет запускаться при старте контейнера - когда вы делаете `docker container run <имя_образа>`):

```dockerfile
FROM scratch

COPY app.bin /

CMD ["/app.bin"]
```

## Итоговый `Dockerfile`

```dockerfile
FROM scratch

COPY app.bin /

CMD ["/app.bin"]
```

Детальную информацию о командах Docker вы можете найти в [официальной документации](https://docs.docker.com/engine/reference/builder/).
