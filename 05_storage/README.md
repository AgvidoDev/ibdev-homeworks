# Домашнее задание к занятию «2.2 Системы хранения данных (кэши, очереди, файловая система)»

В качестве результата пришлите ответы на вопросы в личном кабинете студента на сайте [netology.ru](https://netology.ru).

## Предисловие

Данные ДЗ будут представлять собой лабораторные работы, в рамках которой вы по инструкциям выполните определённые шаги.

## Задание Redis ACL

В рамках данного задания мы разберём новый механизм ACL, появившийся в Redis 6.0.

В качестве целевой конфигурации используйте файл `docker-compose.yml` следующего содержания:

```yaml
version: '3.7'
services:
  cache:
    image: redis:6
    ports:
      - 6379:6379
    volumes:
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
```

Описание настроек:
1. `volumes` позволяет файл конфигурации `redis.conf`, расположенный рядом с вашим `docker-compose.yml` "подключить" в контейнер по пути `/usr/loca/etc/redis/redis.conf` в режиме только для чтения (`ro`)
1. `command` позволяет переопределить команду запуска, запустив сервер Redis с конфигурационным файлом, который мы подключили на предыдущем шаге

**Важно**: все файлы располагаются в каталоге [`assets`](assets):
1. [`docker-compose.yml`](assets/docker-compose.yml)
1. [`redis.conf`](assets/redis.conf)

Вам нужно их скачать на ту машину, на которой вы будете запускать `Docker`.

<details>
<summary>О command</summary>

Инструкция `command` (`CMD` в Dockerfile) может записываться в трёх формах:
1. `[executable, options...]`: exec form - аналог того, что мы делали с вызовом `Command` в Go: shell не используется, запускается только исполняемый файл с переданными параметрами, которые никак не интерпретируются (вспомните разницу между `exec` и `sh -c exec`).
1. `[options...]`: params to ENTRYPOINT - в большинстве кастомизируемых образов пишется специальный Shell Script (см. [PostgreSQL](https://github.com/docker-library/postgres/blob/master/12/docker-entrypoint.sh), [Redis](https://github.com/docker-library/redis/blob/master/6.0/docker-entrypoint.sh)), который запускается при старте контейнера и умеет обрабатывать передаваемые аргументы, фактически, получается: `docker-entrypoint.sh options...`
1. `command options...`: shell form - противоположность первой форме: используется shell, все поля интерпретируются, фактически отрабатывает: `/bin/sh -c command options...`

Предпочтительной в `Dockerfile` является первая форма, в Docker Compose всё зависит от того, определена ли в `Dockerfile` инструкция `ENTRYPOINT`. Если определена, то инструкция `command` будет преобразована во 2-ую форму, если не определена - то в 1-ую форму.
</details>

### Порядок выполнения

#### Часть 1. Настройки по умолчанию

0\. Запустите 4 терминала в каталоге, в котором у вас расположен файл `docker-compose.yml` (либо воспользуйтесь tmux)

1\. Запустите контейнер Redis в первом терминале с настройками по умолчанию: `docker-compose up`

2\. Во втором терминале подключитесь к нему с помощью команды: `docker-compose exec cache redis-cli`

3\. Удостоверьтесь, что вы подключены от лица пользователя `default`: `ACL WHOAMI` (`default` - это пользователь по умолчанию, который оставлен для совместимости с предыдущими версиями Redis, когда понятия пользователей не было)

4\. Удостоверьтесь, что никаких ограничений для вас не установлено: `ACL LIST` 

Вы увидите вывод:
```text
1) "user default on nopass ~* +@all"
```

**Q**: что он означает?

**A**: по полям (слева направо):
1. `user default` - описывается пользователь с именем `default`
1. `on` - пользователь включен (`off` - выключен). Включен/выключен определяют, возможны ли новые подключения, которые попытаются аутентифицироваться под указанным пользователем (выключение пользователя не обрывает текущие соединения)
1. `nopass` - для аутентификации под данным пользователем не требуется пароля (будет подходить любой пароль)
1. `~*` - какие ключи доступны данному пользователю (`~` указывает шаблон, `*` - означает, что все)
1. `+@all` - `+` указывает на то, какие команды доступны пользователю, `-` - какие недоступны. `@` указывает категорию, `all` означает, что все

5\. Удостоверьтесь, что вы можете устанавливать значения ключей командой: `SET users:admin@localhost id:1|name:vasya` (это общепринятая стратегия именования ключей для Redis: `object-type:name` или `object-type:name:field`, где вместо `name` может использоваться какое-то поле, например, `login` или `id`)

6\. Завершите работу контейнера, нажав `Ctrl + C` в первом терминале, где был запущен `docker-compose up` и выполните команду `docker-compose rm` для удаления данных контейнера.

#### Часть 2. Отключение `default`

1\. Отредактируйте файл `redis.conf`: перейдите на 759 строку и добавьте туда следующую запись: `user default off`, после чего сохраните файл

2\. Запустите контейнер Redis в первом терминале: `docker-compose up`

3\. Во втором терминале подключитесь к нему с помощью команды: `docker-compose exec cache redis-cli`

4\. Выполните команду `ACL WHOAMI`, запишите вывод (его нужно будет прислать в результатах выполнения ДЗ)

5\. Выполните команду `ACL LIST`, запишите вывод (его нужно будет прислать в результатах выполнения ДЗ)

6\. Выполните команду `AUTH default`, запишите вывод (его нужно будет прислать в результатах выполнения ДЗ)

7\. Завершите работу контейнера, нажав `Ctrl + C` в первом терминале, где был запущен `docker-compose up` и выполните команду `docker-compose rm` для удаления данных контейнера.

#### Часть 3. Добавление пользователя `app`

1\. Отредактируйте файл `redis.conf`: перейдите на 760 строку и добавьте туда следующую запись: `user app on #2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b ~* +@read +@write`, после чего сохраните файл

**Q**: что эта запись означает?

**A**: по полям (слева направо):
1. `user app` - описывается пользователь с именем `app`
1. `on` - пользователь включен (`off` - выключен)
1. `#hash` - для аутентификации под данным пользователем требуется пароль, в конфигурационном файле Redis будет храниться sha256 хэш
1. `~*` - какие ключи доступны данному пользователю (`~` указывает шаблон, `*` - означает, что все)
1. `+@read +@write` - `+` указывает на то, какие команды доступны пользователю, `@` указывает категорию (см. `ACL CAT read`/`ACL CAT write` для отображения конкретного списка команд в данных категориях)

2\. Запустите контейнер Redis в первом терминале: `docker-compose up`

3\. Во втором терминале подключитесь к нему с помощью команды: `docker-compose exec cache redis-cli`

4\. Аутентифицируйтесь с помощью команды `AUTH app password`, где вместо `password` подставьте пароль, полученный из хэша (вам нужно будет вспомнить, как доставать из хэша пароли)

5\. Выполните команду `ACL WHOAMI`, запишите вывод (его нужно будет прислать в результатах выполнения ДЗ)

6\. Выполните команду `ACL LIST`, запишите вывод (его нужно будет прислать в результатах выполнения ДЗ)

7\. Удостоверьтесь, что вы можете устанавливать значения ключей командой: `SET users:admin@localhost id:1|name:vasya` (это общепринятая стратегия именования ключей для Redis: `object-type:name` или `object-type:name:field`, где вместо `name` может использоваться какое-то поле, например, `login` или `id`)

8\. Завершите работу контейнера, нажав `Ctrl + C` в первом терминале, где был запущен `docker-compose up` и выполните команду `docker-compose rm` для удаления данных контейнера.

#### Часть 4. Включение пользователя `default`

1\. Отредактируйте файл `redis.conf`: перейдите на 759 строку и удалите запись: `user default off`, после чего сохраните файл

2\. Запустите контейнер Redis в первом терминале: `docker-compose up`

3\. Во втором терминале подключитесь к нему с помощью команды: `docker-compose exec cache redis-cli`

4\. Выполните команду `ACL WHOAMI`, запишите вывод (его нужно будет прислать в результатах выполнения ДЗ)

5\. Выполните команду `ACL LIST`, запишите вывод (его нужно будет прислать в результатах выполнения ДЗ)

6\. Удостоверьтесь, что вы можете устанавливать значения ключей командой: `SET users:admin@localhost id:1|name:vasya` (это общепринятая стратегия именования ключей для Redis: `object-type:name` или `object-type:name:field`, где вместо `name` может использоваться какое-то поле, например, `login` или `id`)

7\. Завершите работу контейнера, нажав `Ctrl + C` в первом терминале, где был запущен `docker-compose up` и выполните команду `docker-compose rm` для удаления данных контейнера.

### Результаты выполнения

Пришлите в личном кабинете студента ответы на указанные в разделе **Выполнение** вопросы:
1. По части 2: выводы команд `ACL WHOAMI`, `ACL LIST`, `AUTH default`
1. По части 3: выводы команд `ACL WHOAMI`, `ACL LIST`
1. По части 4: выводы команд `ACL WHOAMI`, `ACL LIST`

### Примечания

1. Чаще всего в реальной конфигурации настройки безопасности выносят в файл отдельный файл и подключают с помощью инструкции `aclfile /path/to/file/users.acl` (мы для упрощения сделали всё в `redis.conf`)
2. Детальное описание работы с ACL в Redis вы можете найти на странице https://redis.io/topics/acl

## Задание Redis ACL LOGS*

**Важно**: это необязательная задача, её (не)выполнение не влияет на получение отчёта по ДЗ.

Используя команду [`ACL LOG`](https://redis.io/commands/acl-log) пришлите отображение следующих событий безопасности:
1. Попытка входа с неверным паролем
1. Попытка доступа к запрещённой команде

**Важно**: вам нужно вводить команду `ACL LOG` (по умолчанию будет выведено до 10 событий). Если вы введёте `ACL LOGS RESET`, то лог будет очищен и придётся повторять всю работу заново.

### Выполнение

Самостоятельно соберите конфигурацию, в которой:
1. У пользователя `default` выставлен пароль `UT]PE6WStAtg="6q` в виде sha256 хэша, доступны все ключи и все команды, пользователь включен
1. У пользователя `app` выставлен пароль в виде sha256 хэша `#2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b`, доступны все ключи, команды доступны только в категориях `@read`, `@write`, пользователь включен

### Результаты выполнения

Пришлите в личном кабинете студента записи из лога событий ACL для следующих событий:
1. Попытка входа с неверным паролем
1. Попытка доступа к неразрешённой команде
